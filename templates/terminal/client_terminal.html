{% extends "base.html" %}

{% block title %}Terminal - {{ client.hostname or client.client_id[:8] }} - CrackPi{% endblock %}

{% block head %}
<style>
.terminal-container {
    background-color: #000;
    color: #00ff00;
    font-family: 'Courier New', monospace;
    border-radius: 8px;
    overflow: hidden;
}

.terminal-header {
    background-color: #333;
    color: #fff;
    padding: 10px 15px;
    border-bottom: 1px solid #555;
    display: flex;
    justify-content: between;
    align-items: center;
}

.terminal-output {
    height: 500px;
    overflow-y: auto;
    padding: 15px;
    background-color: #000;
    color: #00ff00;
    font-size: 14px;
    line-height: 1.4;
}

.terminal-input {
    background-color: #000;
    border: none;
    color: #00ff00;
    padding: 10px 15px;
    width: 100%;
    font-family: 'Courier New', monospace;
    font-size: 14px;
}

.terminal-input:focus {
    outline: none;
    background-color: #111;
}

.terminal-prompt {
    color: #00aa00;
    font-weight: bold;
}

.terminal-command {
    color: #ffffff;
}

.terminal-output-text {
    color: #cccccc;
    white-space: pre-wrap;
}

.terminal-error {
    color: #ff4444;
}

.connection-status {
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #00ff00;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.terminal-toolbar {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 10px 15px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>
                    <i data-feather="terminal"></i> 
                    Terminal - {{ client.hostname or client.client_id[:8] }}
                </h4>
                <div class="d-flex align-items-center gap-3">
                    <div class="connection-status">
                        <div class="status-indicator" id="connectionStatus"></div>
                        <span class="text-muted">Connected</span>
                    </div>
                    <a href="{{ url_for('terminal.terminal_dashboard') }}" class="btn btn-outline-secondary">
                        <i data-feather="arrow-left"></i> Back
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="terminal-toolbar">
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="clearTerminal()">
                            <i data-feather="trash-2"></i> Clear
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="sendCommand('ls -la')">
                            <i data-feather="folder"></i> List Files
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="sendCommand('ps aux')">
                            <i data-feather="activity"></i> Processes
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="sendCommand('top -n 1')">
                            <i data-feather="cpu"></i> System Info
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="interruptCommand()">
                            <i data-feather="square"></i> Interrupt
                        </button>
                    </div>
                </div>
                
                <div class="terminal-container">
                    <div class="terminal-header">
                        <span>{{ current_user.username }}@{{ client.hostname or client.ip_address }}</span>
                        <small class="text-muted">Session: {{ session_id[:8] }}...</small>
                    </div>
                    
                    <div class="terminal-output" id="terminalOutput">
                        <div class="terminal-prompt">
                            CrackPi Terminal Connected to {{ client.client_id[:8] }}...<br>
                            Type commands and press Enter to execute on remote client.<br>
                            <br>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; background-color: #000; padding: 0;">
                        <span class="terminal-prompt" style="padding: 10px 15px;">$</span>
                        <input type="text" 
                               class="terminal-input" 
                               id="commandInput" 
                               placeholder="Enter command..."
                               autofocus>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const sessionId = '{{ session_id }}';
const clientId = '{{ client.client_id }}';
let commandHistory = [];
let historyIndex = -1;
let isExecuting = false;

const terminalOutput = document.getElementById('terminalOutput');
const commandInput = document.getElementById('commandInput');

// Handle command input
commandInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        const command = this.value.trim();
        if (command) {
            executeCommand(command);
            commandHistory.unshift(command);
            historyIndex = -1;
            this.value = '';
        }
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (historyIndex < commandHistory.length - 1) {
            historyIndex++;
            this.value = commandHistory[historyIndex];
        }
    } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (historyIndex > 0) {
            historyIndex--;
            this.value = commandHistory[historyIndex];
        } else {
            historyIndex = -1;
            this.value = '';
        }
    }
});

function executeCommand(command) {
    if (isExecuting) {
        appendToTerminal('Command already executing. Please wait...', 'terminal-error');
        return;
    }
    
    isExecuting = true;
    appendToTerminal(`$ ${command}`, 'terminal-command');
    
    fetch('/terminal/api/execute', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            session_id: sessionId,
            client_id: clientId,
            command: command
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            appendToTerminal(`Error: ${data.error}`, 'terminal-error');
            isExecuting = false;
        } else {
            appendToTerminal('Command sent to client. Waiting for response...', 'text-muted');
            // Start polling for response
            setTimeout(() => pollForResponse(), 1000);
        }
    })
    .catch(error => {
        appendToTerminal(`Error: ${error.message}`, 'terminal-error');
        isExecuting = false;
    });
}

function sendCommand(command) {
    commandInput.value = command;
    executeCommand(command);
}

function pollForResponse() {
    fetch(`/terminal/api/poll/${sessionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.responses && data.responses.length > 0) {
                data.responses.forEach(response => {
                    if (response.stdout) {
                        appendToTerminal(response.stdout, 'terminal-output-text');
                    }
                    if (response.stderr) {
                        appendToTerminal(response.stderr, 'terminal-error');
                    }
                });
                isExecuting = false;
            } else if (isExecuting) {
                // Continue polling if still executing
                setTimeout(() => pollForResponse(), 1000);
            }
        })
        .catch(error => {
            appendToTerminal(`Polling error: ${error.message}`, 'terminal-error');
            isExecuting = false;
        });
}

function appendToTerminal(text, className = '') {
    const div = document.createElement('div');
    div.textContent = text;
    if (className) {
        div.className = className;
    }
    terminalOutput.appendChild(div);
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
}

function clearTerminal() {
    terminalOutput.innerHTML = `
        <div class="terminal-prompt">
            Terminal cleared<br>
        </div>
    `;
}

function interruptCommand() {
    isExecuting = false;
    appendToTerminal('Command interrupted by user', 'terminal-error');
}

// Auto-focus input
commandInput.focus();

// Keep session alive
setInterval(() => {
    fetch(`/terminal/api/poll/${sessionId}`)
        .catch(error => {
            console.log('Keep-alive error:', error);
        });
}, 30000);

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    fetch(`/terminal/api/session/${sessionId}/close`, {
        method: 'POST'
    });
});
</script>
{% endblock %}